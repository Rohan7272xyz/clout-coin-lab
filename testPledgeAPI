// testPledgeAPI.js - ES Module version
import axios from 'axios';

const API_BASE_URL = 'http://localhost:3000';

// Test data
const testUserAddress = '0x1234567890123456789012345678901234567890';
const testInfluencerAddress = '0x0987654321098765432109876543210987654321';

async function testPledgeDatabase() {
  console.log('ğŸ§ª Testing Pledge Database Integration\n');

  try {
    // Test 1: Submit a mock pledge
    console.log('ğŸ“ Test 1: Submitting mock pledge...');
    const pledgeResponse = await axios.post(`${API_BASE_URL}/api/pledge/mock`, {
      userAddress: testUserAddress,
      influencerAddress: testInfluencerAddress,
      amount: '0.5',
      currency: 'ETH'
    });

    console.log('âœ… Pledge submitted:', {
      id: pledgeResponse.data.pledge.id,
      txHash: pledgeResponse.data.pledge.txHash,
      success: pledgeResponse.data.success
    });

    // Test 2: Fetch user pledges
    console.log('\nğŸ“‹ Test 2: Fetching user pledges...');
    const userPledgesResponse = await axios.get(
      `${API_BASE_URL}/api/pledge/user/${testUserAddress}`
    );

    console.log('âœ… User pledges:', {
      count: userPledgesResponse.data.length,
      pledges: userPledgesResponse.data.map(p => ({
        id: p.id,
        influencer: p.influencerName,
        ethAmount: p.ethAmount,
        usdcAmount: p.usdcAmount
      }))
    });

    // Test 3: Get influencer data
    console.log('\nğŸ‘‘ Test 3: Fetching influencer data...');
    const influencerResponse = await axios.get(
      `${API_BASE_URL}/api/pledge/influencer/${testInfluencerAddress}`
    );

    console.log('âœ… Influencer data:', {
      name: influencerResponse.data.name,
      totalPledgedETH: influencerResponse.data.totalPledgedETH,
      pledgerCount: influencerResponse.data.pledgerCount,
      thresholdMet: influencerResponse.data.thresholdMet
    });

    // Test 4: Submit another pledge (USDC this time)
    console.log('\nğŸ’° Test 4: Submitting USDC pledge...');
    const usdcPledgeResponse = await axios.post(`${API_BASE_URL}/api/pledge/mock`, {
      userAddress: testUserAddress,
      influencerAddress: testInfluencerAddress,
      amount: '100',
      currency: 'USDC'
    });

    console.log('âœ… USDC pledge submitted:', {
      id: usdcPledgeResponse.data.pledge.id,
      success: usdcPledgeResponse.data.success
    });

    // Test 5: Verify updated totals
    console.log('\nğŸ”„ Test 5: Verifying updated totals...');
    const updatedUserPledges = await axios.get(
      `${API_BASE_URL}/api/pledge/user/${testUserAddress}`
    );

    const totalETH = updatedUserPledges.data.reduce((sum, p) => sum + parseFloat(p.ethAmount), 0);
    const totalUSDC = updatedUserPledges.data.reduce((sum, p) => sum + parseFloat(p.usdcAmount), 0);

    console.log('âœ… Updated totals:', {
      totalETH: totalETH.toString(),
      totalUSDC: totalUSDC.toString(),
      pledgeCount: updatedUserPledges.data.length
    });

    console.log('\nğŸ‰ All tests passed! Database integration is working correctly.');

  } catch (error) {
    console.error('âŒ Test failed:', {
      message: error.message,
      status: error.response?.status,
      data: error.response?.data
    });

    if (error.code === 'ECONNREFUSED') {
      console.log('\nğŸ’¡ Make sure your backend server is running:');
      console.log('   cd Backend && node index.cjs');
    }
  }
}

// Test database setup
async function testDatabaseSetup() {
  console.log('ğŸ” Testing database setup...\n');

  try {
    // Check if database is accessible
    const healthResponse = await axios.get(`${API_BASE_URL}/api/test/health`);
    console.log('âœ… Database health:', healthResponse.data.services.database);

    // Check required tables
    const tablesResponse = await axios.get(`${API_BASE_URL}/api/test/tables`);
    const requiredTables = ['users', 'influencers', 'pledges', 'pledge_events'];
    const existingTables = tablesResponse.data.tables;

    console.log('ğŸ“‹ Required tables check:');
    requiredTables.forEach(table => {
      const exists = existingTables.includes(table);
      console.log(`   ${exists ? 'âœ…' : 'âŒ'} ${table}`);
    });

    const allTablesExist = requiredTables.every(table => existingTables.includes(table));
    
    if (!allTablesExist) {
      console.log('\nâš ï¸  Missing tables detected. Please run the database migrations:');
      console.log('   Execute: Backend/database/pledge_schema_updates.sql');
      return false;
    }

    return true;

  } catch (error) {
    console.error('âŒ Database setup test failed:', error.message);
    return false;
  }
}

// Main test runner
async function runTests() {
  console.log('ğŸš€ CoinFluence Pledge Database Tests');
  console.log('=====================================\n');

  // First test database setup
  const dbSetupOk = await testDatabaseSetup();
  
  if (!dbSetupOk) {
    console.log('\nğŸ›‘ Database setup issues detected. Please fix and try again.');
    return;
  }

  console.log('\nğŸ“Š Database setup OK. Running pledge tests...\n');
  
  // Then test pledge functionality
  await testPledgeDatabase();
}

// Run the tests
runTests();